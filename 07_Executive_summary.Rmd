---
title: "07_Executive_summary"
author: "Pauline"
date: '2022-05-18'
output: html_document
---

# Objectif environnemental : évolution des évaluations
## Types d'évaluations :
1. IUCN  
2. OSPAR  
3. CIEM / ICES : tous les stocks (55 en tout), sont évalués catégorie 3-6, à part l'aiguillat commun (*Squalus acanthias*) dans l'Atlantique nord-est  qui est catégorie 1.
4. Appendices des conventions

```{r setup, include = F}
library(tidyverse)
library(readxl)
library(writexl)
library(reactablefmtr)
library(flextable)

#plotting
library(GGally)
library(ggbump)
library(ggsankey)

#colours
library(IUCNpalette)
IUCN_palette <- iucn_palette()
IUCN_palette[1] <- "lightgray"
IUCN_palette[8] <- "white"
names_IUCN <- names(iucn_palettes)[1:8]

# Name your color vector
IUCN_colors <-cbind(IUCN_palette, names_IUCN[1:8])

library(RColorBrewer)
palette <- brewer.pal(n = 8, name = "Dark2") #%>% c(., brewer.pal(n = 12, name = "Paired")) %>% c(., brewer.pal(n = 8, name = "Set2"))
```

```{r load_data, echo = F}
#french elasmos
elasmo_FR <- read.csv("data\\elasmo_uicn_france.csv") %>% as_tibble() %>% rename(Species = 'Species')

#IUCN_status
Status_IUCN <- read.csv("data\\Elasmobranchs_IUCN_historical_status.csv", encoding = "UTF-8", check.names = F) %>% 
  rename(Species = 1) %>% #problem with reading colnames...
  filter(Region != "Brazil" & Region != "Canada" & Region != "Venezuela") %>% #remove far away countries
  mutate(Before_last_evaluation = ifelse(is.na(Before_last_status), NA, Before_last_evaluation))
#Conventions
Appendices <- read.csv("data\\Species_cited_in_appendices.csv", check.names = F)

#OSPAR Status
Status_OSPAR <- read.csv("data\\Status_OSPAR.csv", encoding = "UTF-8", check.names = F, sep = ";") %>% rename(Species = 1)#to have symbols

#ICES
ICES_advice <- read_xlsx("data\\ICES_advice_history_updated.xlsx") %>% rename(Species = 'Species')
ICES_stock_cat <- read_xlsx("data/ICES_stock_categories.xlsx") %>% rename(Stock = stock)

#add species' names to stock
ICES_stock_cat <- ICES_stock_cat %>% left_join(ICES_advice[c("Stock", "Species")],., by = "Stock") %>% unique() %>% #55 stocks evaluated
  rename("Stock category" = stock_category)

#print table of stock categories ICES
#write_xlsx(ICES_stock_cat, "data\\ICES_stock_cat.xlsx")
```

# Résumé IUCN France
```{r iucn_fr}
#transform
elasmo_FR$Cat_liste.rouge.France <- factor(elasmo_FR$Cat_liste.rouge.France ,levels = c("NE", "DD","LC", "NT", "VU", "EN", "CR"))

summary_fr <- elasmo_FR %>% group_by(Groupe, Cat_liste.rouge.France) %>% summarise(Species = length(Species)) %>% mutate(Perc_spp = round((Species/98)*100, 2))
write_xlsx(summary_fr, "data\\Summary_elasmo_FR.xlsx")
```

# Résumé de l'évolution des status
## IUCN
```{r load_iucn, echo = FALSE}
#add group and family
Status_IUCN <- left_join(Status_IUCN, elasmo_FR[c("Species", "Groupe", "Family")], by = "Species") %>% relocate(c("Groupe", "Family"), .after = "Nom.commun") 

#transform
Status_IUCN$Before_last_status[is.na(Status_IUCN$Before_last_status)] <- "NE"
Status_IUCN$Last_status <- factor(Status_IUCN$Last_status ,levels = c("NA", "NE", "DD","LC", "NT", "VU", "EN", "CR", "RE"))
Status_IUCN$Before_last_status <- factor(Status_IUCN$Before_last_status ,levels = c("NA", "NE", "DD","LC", "NT", "VU", "EN", "CR", "RE"))

#summary table
summary_evolution <- Status_IUCN %>% filter(Region %in% "World") %>% group_by(Groupe, Status_evolution) %>% summarise(Species = length(Species)) %>% mutate(Perc_spp = round((Species/98)*100, 2))
write_xlsx(summary_evolution, "data\\Summary_evolution.xlsx")

```

### Overview regional
```{r stackedbar_iucn, echo = FALSE}
#group by region, group, status do a stacked bar by group ??
IUCN_summary <- Status_IUCN %>% #get the family from the elasmo_iucn df
  dplyr::group_by(Last_status, Groupe, Region) %>% 
  dplyr::summarise(Nb.species = length(Species))

IUCN_summary_EU <- IUCN_summary %>% filter(Region %in% c("Europe", "Mediterranean Sea", "Baltic Sea", "NE Atlantic"))

#reorder by region
IUCN_summary_EU$Region <- factor(IUCN_summary_EU$Region ,levels = unique(IUCN_summary_EU$Region))
  
status <- ggplot(data = IUCN_summary_EU, aes(x = Last_status, y= Nb.species, fill = as.factor(Groupe))) + 
    geom_bar(stat="identity") + 
    scale_fill_manual(values = palette[4:7]) +
    labs(title = paste("Dernier statut IUCN par région et par groupe d'espèces"), y = "Nombre d'espèces", 
         fill = "Groupe", x = "", subtitle = "98 espèces présentes dans les eaux françaises") +
    theme_minimal() +
    theme(axis.title.x = element_blank(),
        axis.text.x= element_text(size=10,angle = 0),
        axis.text.y = element_text(size=10),
        legend.position = "bottom") + facet_wrap(~Region, ncol = 4)

#save
ggsave("figs\\Regional_status_ligne.png", width = 8, height = 3)
```

### IUCN chimères
```{r chimeres_iucn}
world_chimères <- Status_IUCN %>% #get the family from the elasmo_iucn df
  filter(Region %in% "World") %>% filter(Before_last_status %in% names_IUCN) %>%
  filter(Groupe %in% "Chimères") #%>% min(Before_last_evaluation)
```

### IUCN sharks
```{r sankey_iucn, echo = FALSE}
##sharks
#evolution des statuts
IUCN_sankey_world_sharks <- Status_IUCN %>% #get the family from the elasmo_iucn df
  filter(Region %in% "World") %>% filter(Before_last_status %in% names_IUCN) %>%
  filter(Groupe %in% "Requins") %>%
  select(Last_status, Before_last_status) %>%
  rename("Dernier statut" = Last_status, "Avant-dernier statut" = Before_last_status) %>%
  drop_na() %>% 
  make_long("Avant-dernier statut", "Dernier statut" ) #function from ggsankey needed for plotting

#get ranges of years
world_sharks <- Status_IUCN %>% #get the family from the elasmo_iucn df
  filter(Region %in% "World") %>% filter(Before_last_status %in% names_IUCN) %>%
  filter(Groupe %in% "Requins") #%>% min(Before_last_evaluation)

IUCN_sankey_world_sharks$node <- factor(IUCN_sankey_world_sharks$node ,levels = c("NE", "DD","LC", "NT", "VU", "EN", "CR"))
IUCN_sankey_world_sharks$next_node <- factor(IUCN_sankey_world_sharks$next_node ,levels = c("NE", "DD","LC", "NT", "VU", "EN", "CR"))

sharks_alluvial <- ggplot(IUCN_sankey_world_sharks, 
                          aes(x = x, next_x = next_x, 
                              node = node, next_node = next_node, 
                              fill = factor(node), label = node)) +
  geom_alluvial(flow.alpha = .6) +
  geom_alluvial_text(size = 3, color = "black") +
  scale_fill_manual(values = IUCN_palette) +
  theme_alluvial(base_size = 12) +
  labs(x = NULL) +
  theme(legend.position = "none",
        plot.title = element_text(hjust = .5),
        plot.caption = element_text(size = 10, hjust = 0),
        plot.caption.position = "plot",
        plot.subtitle = element_text(hjust = .5),
        plot.margin=unit(c(0.5,0.5,0.5,0.5), 'cm')) +
  labs(title = "Evolution des statuts mondiaux IUCN", subtitle = "Requins", y = "Nb. d'espèces évaluées", x= "",
       caption = (paste("Note: avant-dernières évaluations: ", min(world_sharks$Before_last_evaluation, na.rm = T), " - ", max(world_sharks$Before_last_evaluation, na.rm = T), ", et dernières évaluations: ", min(world_sharks$Last_evaluation, na.rm = T), " - ", max(world_sharks$Last_evaluation, na.rm = T), ".", sep = ""))) +
  scale_x_discrete(expand = c(0,0)) +
  scale_y_continuous(breaks=seq(0, 60, 10), sec.axis = sec_axis(~., breaks = seq(0, 60, 10)))

ggsave("figs\\IUCN_world_sharks_alluvial2.png", width = 6, height = 8)

#Med sharks
IUCN_sankey_med_sharks <- Status_IUCN %>% #get the family from the elasmo_iucn df
  filter(Region %in% "Mediterranean Sea") %>% filter(Before_last_status %in% names_IUCN) %>%
  filter(Groupe %in% "Requins") %>%
  select(Last_status, Before_last_status) %>%
  rename("Dernier statut" = Last_status, "Avant-dernier statut" = Before_last_status) %>%
  drop_na() %>% 
  make_long("Avant-dernier statut", "Dernier statut" ) #function from ggsankey needed for plotting

IUCN_sankey_med_sharks$node <- factor(IUCN_sankey_med_sharks$node ,levels = c("NE", "DD","LC", "NT", "VU", "EN", "CR"))
IUCN_sankey_med_sharks$next_node <- factor(IUCN_sankey_med_sharks$next_node ,levels = c("NE", "DD","LC", "NT", "VU", "EN", "CR"))

med_sharks_alluvial <- ggplot(IUCN_sankey_med_sharks, aes(x = x, next_x = next_x, node = node, next_node = next_node, fill = factor(node), label = node)) +
  geom_alluvial(flow.alpha = .6) +
  geom_alluvial_text(size = 3, color = "black") +
  scale_fill_manual(values = IUCN_palette[1:7]) +
  theme_alluvial(base_size = 8) +
  labs(x = NULL) +
  theme(legend.position = "none",
        plot.title = element_text(hjust = .5),
        plot.subtitle = element_text(hjust = .5),
        axis.text.x=element_text(size=8)) +
  labs(title = "Evolution des statuts méditerranéens IUCN", subtitle = "Requins", x = "", y = "Nb. d'espèces évaluées") +
  scale_x_discrete(expand = c(0,0)) +
  scale_y_continuous(sec.axis = sec_axis(~.))

ggsave("figs\\IUCN_med_sharks_alluvial2.png", width = 6, height = 8)
```

### IUCN rays
```{r iucn_rays}
#Rays
#only World and Med Sea have consistently 2 evaluations
## World
IUCN_sankey_world_rays <- Status_IUCN %>% #get the family from the elasmo_iucn df
  filter(Region %in% "World") %>% filter(Before_last_status %in% names_IUCN) %>%
  filter(Groupe %in% "Raies") %>%
  select(Last_status, Before_last_status) %>%
  rename("Dernier statut" = Last_status, "Avant-dernier statut" = Before_last_status) %>%
  drop_na() %>% 
  make_long("Avant-dernier statut", "Dernier statut" ) #function from ggsankey needed for plotting

#get ranges of years
world_rays <- Status_IUCN %>% #get the family from the elasmo_iucn df
  filter(Region %in% "World") %>% filter(Before_last_status %in% names_IUCN) %>%
  filter(Groupe %in% "Raies") #%>% min(Before_last_evaluation)

IUCN_sankey_world_rays$node <- factor(IUCN_sankey_world_rays$node ,levels = c("NE", "DD","LC", "NT", "VU", "EN", "CR"))
IUCN_sankey_world_rays$next_node <- factor(IUCN_sankey_world_rays$next_node ,levels = c("NE", "DD","LC", "NT", "VU", "EN", "CR"))

rays_alluvial <- ggplot(IUCN_sankey_world_rays, aes(x = x, next_x = next_x, node = node, next_node = next_node, fill = factor(node), label = node)) +
  geom_alluvial(flow.alpha = .6) +
  geom_alluvial_text(size = 3, color = "black") +
  scale_fill_manual(values = IUCN_palette[1:8]) +
  theme_alluvial(base_size = 12) +
  labs(x = NULL) +
  theme(legend.position = "none",
        plot.title = element_text(hjust = .5),
        plot.subtitle = element_text(hjust = .5),
        axis.text.x=element_text(size=12),
        plot.caption = element_text(size = 10, hjust = 0, vjust = 0.1),
        plot.caption.position = "plot",
        plot.margin=unit(c(0.5,0.5,0.5,0.5), 'cm')) +
  labs(title = "Evolution des statuts mondiaux IUCN", subtitle = "Raies", y = "Nb. d'espèces évaluées", x = "",
       caption = (paste("Note: avant-dernières évaluations: ", min(world_rays$Before_last_evaluation, na.rm = T), " - ", max(world_rays$Before_last_evaluation, na.rm = T), ", et dernières évaluations: ", min(world_rays$Last_evaluation, na.rm = T), " - ", max(world_rays$Last_evaluation, na.rm = T), ".", sep = ""))) +
  scale_x_discrete(expand = c(0,0)) +
  scale_y_continuous(breaks=seq(0, 60, 10), sec.axis = sec_axis(~., breaks = seq(0, 60, 10)))

ggsave("figs\\IUCN_world_rays_alluvial2.png", width = 6, height = 8)

#Med rays
IUCN_sankey_med_rays <- Status_IUCN %>% #get the family from the elasmo_iucn df
  filter(Region %in% "Mediterranean Sea") %>% filter(Before_last_status %in% names_IUCN) %>%
  filter(Groupe %in% "Raies") %>%
  select(Last_status, Before_last_status) %>%
  rename("Dernier statut" = Last_status, "Avant-dernier statut" = Before_last_status) %>%
  drop_na() %>% 
  make_long("Avant-dernier statut", "Dernier statut" ) #function from ggsankey needed for plotting

IUCN_sankey_med_rays$node <- factor(IUCN_sankey_med_rays$node ,levels = c("NE", "DD","LC", "NT", "VU", "EN", "CR"))
IUCN_sankey_med_rays$next_node <- factor(IUCN_sankey_med_rays$next_node ,levels = c("NE", "DD","LC", "NT", "VU", "EN", "CR"))

#need to customize palette because of problem
palette_medrays[5] <- IUCN_palette[1]
palette_medrays[2] <- IUCN_palette[2]
palette_medrays[4] <- IUCN_palette[4]
palette_medrays[3] <- IUCN_palette[3]
palette_medrays[5] <- IUCN_palette[7]
palette_medrays <- rev(IUCN_palette[1:7])
palette

med_rays_alluvial <- ggplot(IUCN_sankey_med_rays, aes(x = x, next_x = next_x, node = node, next_node = next_node, label = node)) +
  geom_alluvial(flow.alpha = .6,  aes(fill = node)) +
  scale_fill_manual(values = IUCN_palette) +
  geom_alluvial_text(size = 3, color = "black") +
  theme_alluvial(base_size = 8) +
  labs(x = NULL) +
  theme(legend.position = "none",
        plot.title = element_text(hjust = .5),
        plot.subtitle = element_text(hjust = .5),
        axis.text.x=element_text(size=8)) +
  labs(title = "Evolution des statuts méditerranéens IUCN", subtitle = "Raies", x = "", y = "Nb. d'espèces évaluées") +
  scale_x_discrete(expand = c(0,0)) +
  scale_y_continuous(sec.axis = sec_axis(~.))

ggsave("figs\\IUCN_med_rays_alluvial2.png", width = 6, height = 8)
IUCN_colors
rays_palette <- c("lightgray", "#008000", "#FFFF00", "#FFA500", "#FF0000", "#808080", "#ADFF2F")
#c("NE" = "lightgray", "CR" = "#808080", "EN" = "#008000", "VU" = "#ADFF2F", "NT" = "#FFFF00", "LC" = "#FFA500", "DD" = "#FF0000")
```

## OSPAR
```{r ospar, echo = FALSE}
Status_OSPAR$Region[Status_OSPAR$Region == "II*"] <- "II"
Status_OSPAR_summary <- Status_OSPAR %>% select(-Previous_status, -Year) %>% pivot_wider(names_from = "Region", values_from = "Last_status")

write_xlsx(Status_OSPAR_summary, "data\\Status_OSPAR_summary.xlsx")

palette_OSPAR <- cbind("Forestgreen", "Lightblue", "Tomato", "Gold", "Lightgray")

heatmap.ospar <- ggplot(Status_OSPAR, aes(Region, Species)) +
  geom_tile(aes(fill = Last_status), colour = "white", lwd = .75) +
  scale_fill_manual(values = palette_OSPAR) + 
  theme_grey() +
  theme(axis.title.x = element_blank(),
        axis.text.x= element_text(size=9, angle = 45, vjust = 0.5),
        axis.text.y = element_text(size=9),
        title = element_text(size = 10),
        legend.position = "right",
        plot.margin=unit(c(0.5,0.5,0.5,0.5), 'cm')) +
  labs(y = "", legend = "Dernier statut", title = "Derniers statuts OSPAR (POSH)", subtitle = "Evaluation de 2021") +
  guides(fill=guide_legend(title="Dernier statut"))

ggsave("figs\\heatmap_ospar.png", width = 6, height  = 4)
```

# Zoom sur les espèces évaluées "DD" par l'IUCN France en 2013
```{r dd_fr_iucn}
#filter DD france
species_DD_FR <- Status_IUCN %>% filter(Region %in% "France" & Last_status %in% "DD")
species_DD_FR <- species_DD_FR$Species
IUCN_DD_FR <- Status_IUCN %>% filter(Species %in% species_DD_FR) %>% filter(Region != "France") %>% mutate_all(as.character)
IUCN_DD_FR$Last_status <- factor(IUCN_DD_FR$Last_status ,levels = c("NA", "NE", "DD","LC", "NT", "VU", "EN", "CR", "RE"))

#create two way table
IUCN_DD_FR_freq <- table(IUCN_DD_FR$Region, IUCN_DD_FR$Last_status) %>% as.data.frame() %>% 
  pivot_wider(names_from = Var2, values_from = Freq) %>% mutate(Total = select(., "NA":"RE") %>% rowSums(na.rm = TRUE)) %>% rename(Region = Var1)

write_xlsx(IUCN_DD_FR_freq, "data\\IUCN_DD_FR.xlsx")

#heatmap
heatmap.DD_FR <- ggplot(IUCN_DD_FR, aes(Region, Species)) +
  geom_tile(aes(fill = Last_status), colour = "white", lwd = .75) +
  scale_fill_manual(values = IUCN_palette[1:8]) + 
  theme_grey() +
  theme(axis.title.x = element_blank(),
        axis.text.x= element_text(size=12, angle = 45, vjust = 0.5),
        axis.text.y = element_text(size=12),
        legend.position = "bottom")

ggsave("figs\\heatmap_dd_fr.png", width = 8, height  = 12)
```


```{r}

```

# Annexe
```{r tableaux_annexe, echo = FALSE}

```