---
title: "Export_html_tables"
author: "Pauline"
date: '2022-05-06'
output: html_document
---
This file exports the tables formatted as html. This is an easy and visual way to present the data.
```{r setup, include = F}
library(tidyverse)
library(reactablefmtr)
```

# Load data
```{r data}
#IUCN_status
Elasmobranchs_IUCN_historical_status <- read_xlsx("data\\Elasmobranchs_IUCN_historical_status.xlsx") %>% filter(Region != "France (continental)") %>% select(-"Before_last_evaluation", -"Before_last_status")

#Conventions
Appendices <- read.csv("data\\Species_cited_in_appendices.csv", check.names = F)

#OSPAR Status
Status_OSPAR <- read.csv("data\\Status_OSPAR.csv", encoding = "UTF-8", check.names = F) #to have symbols

#ICES
ICES_stock_cat <- read.csv("data\\ICES_stock_categories.csv", encoding = "UTF-8", check.names = F) %>% select(-1) %>%
  rename(Stock = stock)#drop id col
ICES_advice <- read.csv("data\\ICES_advice_history.csv", encoding = "UTF-8", check.names = F) %>% select(-1) #drop 1st id col
```

# Elasmo historical table
```{r display_iucn}
#need to convert all to character
Elasmobranchs_IUCN_historical_status <- Elasmobranchs_IUCN_historical_status %>% mutate(across(everything(), as.character)) %>%
  relocate(Last_status, .after = Region)

Elasmobranchs_IUCN_historical_status[is.na(Elasmobranchs_IUCN_historical_status)] <- " " #replace NAs by blank for better visualisation
colnames(Elasmobranchs_IUCN_historical_status)

#translate
Elasmobranchs_IUCN_historical_status$Region[Elasmobranchs_IUCN_historical_status$Region == "Baltic Sea"] <- "Baltique"
Elasmobranchs_IUCN_historical_status$Region[Elasmobranchs_IUCN_historical_status$Region == "Mediterranean Sea"] <- "Méditerranée"
Elasmobranchs_IUCN_historical_status$Region[Elasmobranchs_IUCN_historical_status$Region == "Croatia"] <- "Croatie"
Elasmobranchs_IUCN_historical_status$Region[Elasmobranchs_IUCN_historical_status$Region == "Italy"] <- "Italie"
Elasmobranchs_IUCN_historical_status$Region[Elasmobranchs_IUCN_historical_status$Region == "Ireland"] <- "Irlande"
Elasmobranchs_IUCN_historical_status$Region[Elasmobranchs_IUCN_historical_status$Region == "World"] <- "Monde"
Elasmobranchs_IUCN_historical_status$Region[Elasmobranchs_IUCN_historical_status$Region == "Sweden"] <- "Suède"
Elasmobranchs_IUCN_historical_status$Region[Elasmobranchs_IUCN_historical_status$Region == "Norway"] <- "Norvège"
Elasmobranchs_IUCN_historical_status$Region[Elasmobranchs_IUCN_historical_status$Region == "Albania"] <- "Albanie"
Elasmobranchs_IUCN_historical_status$Region[Elasmobranchs_IUCN_historical_status$Region == "Germany"] <- "Allemagne"
Elasmobranchs_IUCN_historical_status$Region[Elasmobranchs_IUCN_historical_status$Region == "United Kingdom"] <- "Royaume-Uni"
Elasmobranchs_IUCN_historical_status$Region[Elasmobranchs_IUCN_historical_status$Region == "NE Atlantic"] <- "Atlantique NE"
Elasmobranchs_IUCN_historical_status$Region[Elasmobranchs_IUCN_historical_status$Region == "World"] <- "Monde"
Elasmobranchs_IUCN_historical_status$Level[Elasmobranchs_IUCN_historical_status$Level == "Regional"] <- "Régional"

#Translate the column names to french
Elasmobranchs_IUCN_historical_status <- Elasmobranchs_IUCN_historical_status %>% 
  rename(Espèce = 1,
         `Nom commun` = Nom.commun,
         Niveau = Level,
         Région = Region,
         `Dernier statut` = Last_status,
         `Evolution du statut` = Status_evolution,
         `Années écoulées` = Years_apart,
         `Dernière évaluation` = Last_evaluation)

Appendices_long <- Appendices %>% select(-CITES_listing_year) %>%
  rename(Berne = BERN_appendix, Barcelone = Barcelona_appendix, Washington = CITES_appendix, Bonn = CMS_appendix,
         Espèce = "ï»¿Species") %>%
  pivot_longer(cols = Berne : Bonn, names_to = "conventions", values_to = "Détail") %>%
  unite(conventions:"Détail", col = conventions, remove = TRUE, sep = " ", na.rm = T) %>%
  dplyr::group_by(Espèce) %>% dplyr::summarise(conventions = paste(unique(conventions), sep = ", "))

#ctable package
Elasmo_IUCN_html <- reactable(Elasmobranchs_IUCN_historical_status,
                  pagination = F, #all on one page
                  filterable = T,
                  showPageSizeOptions = T,
                  onClick = "select", #select the row when you click
                  highlight = T, #highlight the rows on hover
                  striped = T, #strip rows
        defaultColDef = colDef( #style last_status column according to IUCN colors
    style = function(status) {
      if(status == "CR"){
        color <- "red"
      }
      else if(status == "EN") {
        color <- "orange"
      }
      else if (status == "VU") {
        color <- "gold"
      }
      else if (status == "NT") {
        color <- "forestgreen"
      }
      else if (status == "LC") {
       color <- "lightgreen" 
      }
      
      else if(status == "DD") {
        color <- "lightgrey"
      }
      else{
        color <- "white"
      }
      list(background = color)
    }
  )
)

save_reactable_test(Elasmo_IUCN_html, "html_output/Elasmo_IUCN_historical_table.html")
```

# Convention tables
```{r convention}
appendices_html <- reactable(Appendices, 
                             pagination = F, 
                             highlight = T, 
                             striped = T,
                             filterable = T)
save_reactable_test(appendices_html, "html_output/Appendices_html_table.html")
```

# OSPAR table
```{r ospar}
#create colors
status_color <- Status_OSPAR %>% 
  mutate(status_colors = dplyr::case_when(
  Last_status == 'Poor' ~ 'tomato',
  Last_status == 'Good' ~ 'forestgreen',
  Last_status == '?' ~ 'dodgerblue'
  ))


#reactable package
OSPAR_html <- reactable(status_color,
                        pagination = F,
                        highlight = T,
                        filterable = T,
                        striped = T,
                        defaultSorted = 'Last_status',
                        columns = list(
                          Last_status = colDef(
                            style = color_scales(status_color, color_ref = 'status_colors')),
                            status_colors = colDef(show = FALSE)
                          ))
save_reactable_test(OSPAR_html, "html_output/OSPAR_html_table.html")
```

# ICES advice
```{r ICES}
#bind stock_cats and stock_advice
ICES_advice <- left_join(ICES_advice, ICES_stock_cat, by = "Stock")

#pivot to wide format
ICES_wide <- ICES_advice %>% filter(Year %in% "2018":"2023") %>% pivot_wider(names_from = Year, values_from = Advice) %>% relocate(Stock, stock_category)

#reactable package
ICES_html <- reactable(ICES_wide,
                        pagination = F,
                        highlight = T,
                        striped = T,
                       filterable = T)

save_reactable_test(ICES_html, "html_output/ICES_html_table.html")
```
